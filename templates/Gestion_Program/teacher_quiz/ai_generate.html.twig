{% extends 'base.html.twig' %}

{% block title %}AI Quiz Generator - {{ classeCourse.course.title }} - UniLearn{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Header #}
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="d-flex align-items-center">
            <a href="{{ path('app_teacher_classe_show', {id: teacherClasse.id}) }}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h1 class="h3 mb-1">
                    <i class="bi bi-robot text-primary"></i> AI Quiz Generator
                </h1>
                <p class="text-muted mb-0">
                    Generate quiz questions from your course materials using AI
                </p>
            </div>
        </div>
        <a href="{{ path('app_teacher_quiz_create', {teacherClasseId: teacherClasse.id, courseId: classeCourse.id}) }}" 
           class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Create Manually
        </a>
    </div>

    {# Flash Messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{{ label == 'success' ? 'check-circle' : (label == 'error' ? 'exclamation-triangle' : 'info-circle') }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <div class="row g-4">
        {# Upload Section #}
        <div class="col-lg-5">
            <div class="card card-elevated">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Upload Source Material</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="generate-form">
                        <input type="hidden" name="_token" value="{{ csrf_token('ai_generate' ~ teacherClasse.id) }}">
                        <input type="hidden" name="action" value="generate">

                        <div class="mb-4">
                            <label class="form-label">Source File <span class="text-danger">*</span></label>
                            <div class="upload-zone p-4 text-center border-2 border-dashed rounded-3" 
                                 id="upload-zone"
                                 ondrop="handleDrop(event)" 
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)">
                                <i class="bi bi-file-earmark-arrow-up text-primary" style="font-size: 3rem;"></i>
                                <p class="mt-3 mb-2 fw-medium">Drop your file here or click to browse</p>
                                <p class="text-muted small mb-3">Supported: PDF, DOCX, TXT</p>
                                <input type="file" class="d-none" id="source_file" name="source_file" 
                                       accept=".pdf,.docx,.doc,.txt" onchange="handleFileSelect(this)">
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('source_file').click()">
                                    <i class="bi bi-folder2-open"></i> Browse Files
                                </button>
                            </div>
                            <div id="file-preview" class="mt-3 d-none">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class="bi bi-file-earmark-text text-primary me-3" style="font-size: 2rem;"></i>
                                    <div class="flex-grow-1">
                                        <div id="file-name" class="fw-medium"></div>
                                        <small id="file-size" class="text-muted"></small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-4">
                                <label for="num_questions" class="form-label">Number of Questions</label>
                                <select class="form-select" id="num_questions" name="num_questions">
                                    <option value="3">3 Questions</option>
                                    <option value="5" selected>5 Questions</option>
                                    <option value="10">10 Questions</option>
                                    <option value="15">15 Questions</option>
                                    <option value="20">20 Questions</option>
                                </select>
                            </div>
                            <div class="col-6 mb-4">
                                <label for="difficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="difficulty" name="difficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="generate-btn">
                            <i class="bi bi-magic"></i> Generate Questions
                        </button>
                    </form>

                    <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
                        <h6 class="text-info mb-2"><i class="bi bi-lightbulb me-1"></i> Tips for best results:</h6>
                        <ul class="small text-muted mb-0 ps-3">
                            <li>Use clear, well-structured documents</li>
                            <li>Include key concepts and definitions</li>
                            <li>Longer documents produce better variety</li>
                            <li>Review and edit generated questions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        {# Generated Questions Section #}
        <div class="col-lg-7">
            <div class="card card-elevated">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Generated Questions
                        {% if generatedQuestions|default([])|length > 0 %}
                            <span class="badge bg-success ms-2">{{ generatedQuestions|length }}</span>
                        {% endif %}
                    </h5>
                    {% if generatedQuestions|default([])|length > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearQuestions()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if generatedQuestions|default([])|length > 0 %}
                        <form method="post" id="create-quiz-form">
                            <input type="hidden" name="_token" value="{{ csrf_token('create_ai_quiz' ~ teacherClasse.id) }}">
                            <input type="hidden" name="action" value="create_quiz">

                            <div class="mb-4 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="quiz_title" class="form-label">Quiz Title <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="quiz_title" name="quiz_title" 
                                               required placeholder="Enter quiz title"
                                               value="AI Generated Quiz - {{ classeCourse.course.title }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="quiz_description" class="form-label">Description</label>
                                        <input type="text" class="form-control" id="quiz_description" name="quiz_description" 
                                               placeholder="Optional description">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <input type="checkbox" class="form-check-input me-2" id="select-all" onchange="toggleSelectAll(this)">
                                        <label for="select-all" class="form-check-label">Select All</label>
                                        <span class="text-muted ms-2">(<span id="selected-count">0</span> selected)</span>
                                    </div>
                                    <button type="submit" class="btn btn-success" id="create-quiz-btn" disabled>
                                        <i class="bi bi-plus-circle"></i> Create Quiz
                                    </button>
                                </div>
                            </div>

                            <div class="questions-list" style="max-height: 600px; overflow-y: auto;">
                                {% for index, question in generatedQuestions %}
                                    <div class="question-item p-3 mb-3 border rounded">
                                        <div class="d-flex align-items-start mb-2">
                                            <input type="checkbox" class="form-check-input me-3 mt-1 question-checkbox" 
                                                   name="selected_questions[]" value="{{ index }}" 
                                                   id="q_{{ index }}" onchange="updateSelectedCount()">
                                            <div class="flex-grow-1">
                                                <label for="q_{{ index }}" class="fw-medium mb-2" style="cursor: pointer;">
                                                    <span class="badge bg-secondary me-2">Q{{ loop.index }}</span>
                                                    {{ question.questionText }}
                                                </label>
                                                
                                                <div class="choices-list mt-2">
                                                    {% for choice in question.choices %}
                                                        <div class="d-flex align-items-center py-1">
                                                            {% if choice.isCorrect %}
                                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            {% else %}
                                                                <i class="bi bi-circle text-muted me-2"></i>
                                                            {% endif %}
                                                            <span class="{{ choice.isCorrect ? 'fw-medium text-success' : 'text-muted' }}">
                                                                {{ choice.text }}
                                                            </span>
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                {% if question.explanation %}
                                                    <div class="mt-2 p-2 bg-info bg-opacity-10 rounded small">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        {{ question.explanation }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <span class="badge bg-primary">{{ question.points }} pt{{ question.points > 1 ? 's' : '' }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </form>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <h5 class="mt-3 text-muted">No questions generated yet</h5>
                            <p class="text-muted">Upload a document and click "Generate Questions" to get started</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-zone {
    border: 2px dashed var(--gray-300);
    background: var(--surface-card);
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--primary-500);
    background: rgba(102, 126, 234, 0.05);
}

.question-item {
    background: var(--surface-card);
    transition: all 0.2s ease;
}

.question-item:hover {
    border-color: var(--primary-400) !important;
}

.choices-list {
    padding-left: 1.5rem;
}

[data-theme="light"] .upload-zone {
    border-color: var(--gray-300);
    background: #ffffff;
}

[data-theme="light"] .upload-zone:hover,
[data-theme="light"] .upload-zone.dragover {
    background: rgba(76, 110, 245, 0.05);
}

[data-theme="light"] .question-item {
    background: #ffffff;
}
</style>

<script>
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('upload-zone').classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('upload-zone').classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('upload-zone').classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const input = document.getElementById('source_file');
        input.files = files;
        handleFileSelect(input);
    }
}

function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/msword'];
        const extension = file.name.split('.').pop().toLowerCase();
        const allowedExtensions = ['pdf', 'docx', 'doc', 'txt'];
        
        if (!allowedExtensions.includes(extension)) {
            alert('Please upload a PDF, DOCX, or TXT file.');
            input.value = '';
            return;
        }
        
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-preview').classList.remove('d-none');
        document.getElementById('upload-zone').querySelectorAll('i, p, button').forEach(el => el.style.display = 'none');
    }
}

function clearFile() {
    document.getElementById('source_file').value = '';
    document.getElementById('file-preview').classList.add('d-none');
    document.getElementById('upload-zone').querySelectorAll('i, p, button').forEach(el => el.style.display = '');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.question-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.question-checkbox:checked').length;
    const total = document.querySelectorAll('.question-checkbox').length;
    document.getElementById('selected-count').textContent = checked;
    document.getElementById('create-quiz-btn').disabled = checked === 0;
    document.getElementById('select-all').checked = checked === total && total > 0;
    document.getElementById('select-all').indeterminate = checked > 0 && checked < total;
}

function clearQuestions() {
    if (confirm('Clear all generated questions?')) {
        window.location.href = window.location.href.split('?')[0] + '?clear=1';
    }
}

// Show loading state on form submit
document.getElementById('generate-form')?.addEventListener('submit', function(e) {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generating...';
});

// Initialize selected count
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
});
</script>
{% endblock %}
